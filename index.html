<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <title>Vers√≠culo Diario</title>
  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow: hidden; }
    #verse-container { padding: 30px; max-width: 600px; width: 90%; }
    #verse { font-size: 1.6rem; font-style: italic; margin-bottom: 25px; line-height: 1.5; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); }
    #reference { font-weight: bold; margin-top: 15px; color: #bb86fc; font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; }
    
    button { margin-top: 30px; padding: 15px 30px; border: none; cursor: pointer; border-radius: 50px; font-weight: 800; font-size: 0.9rem; transition: transform 0.2s; width: 100%; max-width: 300px; }
    button:active { transform: scale(0.95); }
    #btn-notify { background: #03dac6; color: #000; box-shadow: 0 4px 15px rgba(3, 218, 198, 0.4); }
    #btn-unsubscribe { background: #cf6679; color: #000; box-shadow: 0 4px 15px rgba(207, 102, 121, 0.4); display: none; }
    
    .version-footer {
        position: fixed; bottom: 15px; width: 100%; text-align: center;
        font-size: 0.75rem; color: #555; font-family: monospace;
        pointer-events: none; opacity: 0.7;
    }
  </style>
</head>
<body>
  <div id="verse-container">
    <div id="verse">Cargando inspiraci√≥n...</div>
    <div id="reference"></div>
    
    <button id="btn-notify" onclick="window.subscribeUser()">üîî RECIBIR VERS√çCULO DIARIO</button>
    <button id="btn-unsubscribe" onclick="window.unsubscribeUser()">üîï DETENER NOTIFICACIONES</button>
  </div>

  <div id="version-footer" class="version-footer">Cargando versi√≥n...</div>

  <script type="module">
    import { versesDB } from './js/verses.js';

    // TU NUEVA VAPID KEY
    const PUBLIC_VAPID_KEY = 'BLAmSvWiwybGELdtlKxn1XH_ftdsMs2IpWshmmPWGUF3ndWSS06tXY4oFAcUEHbYQPcDaaOl_6cwNjaFM0bmUhI';
    
    let currentVerseData = null;

    // --- 1. Leer versi√≥n del Service Worker ---
    async function showVersionFromSW() {
        try {
            const response = await fetch('./sw.js?t=' + new Date().getTime());
            const text = await response.text();
            const match = text.match(/const\s+CACHE_NAME\s*=\s*['"]([^'"]+)['"]/);
            if (match && match[1]) {
                const version = match[1].replace('biblia-', '');
                document.getElementById('version-footer').innerText = `App: ${version}`;
            }
        } catch (e) { document.getElementById('version-footer').innerText = "v?.?"; }
    }

    // --- 2. Renderizar Vers√≠culo ---
    function renderVerse(data) {
        currentVerseData = data;
        document.getElementById('verse').innerText = `"${data.t}"`;
        document.getElementById('reference').innerText = data.r;
    }

    // --- 3. Carga Inteligente (API -> Local) ---
    async function loadSmartVerse() {
       try {
           const response = await fetch('/api/current-verse?t=' + new Date().getTime());
           if (response.ok) {
               const serverData = await response.json();
               renderVerse(serverData);
               return;
           }
       } catch (e) { console.log("Offline, usando local."); }
       
       const today = new Date().getDate(); 
       const randomItem = versesDB[today % versesDB.length]; 
       renderVerse(randomItem);
    }

    // Actualizar si vuelve a ser visible
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") loadSmartVerse();
    });

    // --- 4. Utilidades VAPID ---
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    function updateUI(isSubscribed) {
        const btnSub = document.getElementById('btn-notify');
        const btnUnsub = document.getElementById('btn-unsubscribe');
        if (isSubscribed) {
            btnSub.style.display = 'none';
            btnUnsub.style.display = 'inline-block';
        } else {
            btnSub.style.display = 'inline-block';
            btnUnsub.style.display = 'none';
        }
    }

    // --- 5. Funciones de Suscripci√≥n ---
    window.subscribeUser = async function() {
      if (!('serviceWorker' in navigator)) return;

      try {
        const registration = await navigator.serviceWorker.ready;
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;

        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
        });

        const response = await fetch('/api/subscribe', {
          method: 'POST',
          body: JSON.stringify({ subscription, firstVerse: currentVerseData }),
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            // Marca PWA como configurada
            localStorage.setItem('setup_v1_pwa', 'true');
            updateUI(true);
            console.log("‚úÖ Suscripci√≥n exitosa.");
        } 

      } catch (err) { console.error("Error:", err); }
    }

    window.unsubscribeUser = async function() {
      if (!('serviceWorker' in navigator)) return;
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        if (subscription) {
            await fetch('/api/unsubscribe', {
                method: 'POST',
                body: JSON.stringify({ endpoint: subscription.endpoint }),
                headers: { 'Content-Type': 'application/json' }
            });
            await subscription.unsubscribe();
            // Borramos la marca para permitir re-suscripci√≥n
            localStorage.removeItem('setup_v1_pwa');
        }
        updateUI(false);
      } catch (err) { console.error(err); }
    }

    // --- 6. Inicializaci√≥n ---
    showVersionFromSW();
    loadSmartVerse();
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
      navigator.serviceWorker.ready.then(async (reg) => {
        try {
          const sub = await reg.pushManager.getSubscription();
          
          // --- L√ìGICA DE DETECCI√ìN DE APP ---
          const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
          // Buscamos la variable nueva
          const isSetupDone = localStorage.getItem('setup_v1_pwa');

          if (isStandalone && !isSetupDone) {
              // Si es la App y no tiene la marca nueva, mostramos el bot√≥n
              console.log("üÜï App instalada detectada: Forzando setup.");
              updateUI(false); 
          } else {
              updateUI(!!sub);
          }
        } catch(e){}
      });
    }
  </script>
</body>
</html>
