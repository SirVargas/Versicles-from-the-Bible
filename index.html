<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <title>Vers√≠culo Diario</title>
  
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow-x: hidden; }
    
    #main-container { width: 90%; max-width: 600px; position: relative; padding-bottom: 50px; }

    #verse { font-size: 1.5rem; font-style: italic; margin-bottom: 20px; line-height: 1.4; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); opacity: 0; }
    #reference { font-weight: bold; margin-top: 10px; color: #bb86fc; font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0; }
    
    @keyframes fadeInUpSubtle {
        0% { opacity: 0; transform: translateY(20px); filter: blur(5px); }
        100% { opacity: 1; transform: translateY(0); filter: blur(0); }
    }
    .fade-up { animation: fadeInUpSubtle 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

    .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; align-items: center; }
    button { padding: 15px 25px; border: none; cursor: pointer; border-radius: 50px; font-weight: 800; font-size: 0.9rem; width: 100%; max-width: 300px; transition: transform 0.2s; }
    button:active { transform: scale(0.95); }
    
    #btn-scan { background: linear-gradient(45deg, #bb86fc, #3700b3); color: white; box-shadow: 0 4px 15px rgba(187, 134, 252, 0.4); display: flex; align-items: center; justify-content: center; gap: 10px; }
    #btn-notify { background: #03dac6; color: #000; box-shadow: 0 4px 15px rgba(3, 218, 198, 0.4); }
    #btn-unsubscribe { background: #cf6679; color: #000; display: none; }

    .version-footer { position: fixed; bottom: 5px; width: 100%; text-align: center; font-size: 0.7rem; color: #555; pointer-events: none; }

    /* C√ÅMARA */
    #camera-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 1000; flex-direction: column; align-items: center; justify-content: center;
    }
    #video-feed {
        width: 100%; max-width: 400px; border-radius: 20px; border: 4px solid #bb86fc;
        transform: scaleX(-1);
    }
    #scan-status { margin-top: 20px; font-size: 1.2rem; color: #03dac6; font-weight: bold; }
    #btn-close-cam { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; cursor: pointer; }
  </style>
</head>
<body>

  <div id="main-container">
    <div id="verse">Cargando inspiraci√≥n...</div>
    <div id="reference"></div>
    
    <div class="btn-group">
        <button id="btn-scan" onclick="startMoodScan()">üì∏ ESCANEAR √ÅNIMO</button>
        <button id="btn-notify" onclick="window.subscribeUser()">üîî ACTIVAR EXPERIENCIA</button>
        <button id="btn-unsubscribe" onclick="window.unsubscribeUser()">üîï DETENER</button>
    </div>
  </div>

  <div id="camera-overlay">
      <div id="btn-close-cam" onclick="stopCamera()">‚úï</div>
      <video id="video-feed" autoplay muted playsinline></video>
      <div id="scan-status">Iniciando...</div>
  </div>

  <div id="version-footer" class="version-footer">Cargando versi√≥n...</div>

  <script type="module">
    import { versesDB } from './js/verses.js';

    const PUBLIC_VAPID_KEY = 'BLAmSvWiwybGELdtlKxn1XH_ftdsMs2IpWshmmPWGUF3ndWSS06tXY4oFAcUEHbYQPcDaaOl_6cwNjaFM0bmUhI';
    let currentVerseData = null;
    let videoStream = null;
    let modelsLoaded = false;
    let isScanning = false;

    // --- 1. L√ìGICA DE IA Y C√ÅMARA ---
    window.startMoodScan = async function() {
        const overlay = document.getElementById('camera-overlay');
        const status = document.getElementById('scan-status');
        const video = document.getElementById('video-feed');
        
        overlay.style.display = 'flex';
        status.innerText = "Conectando c√°mara...";
        isScanning = true;

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = videoStream;

            if (!modelsLoaded) {
                status.innerText = "Preparando IA...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                modelsLoaded = true;
            }

            status.innerText = "Analizando tu rostro...";
            detectEmotionLoop();

        } catch (err) {
            console.error("Error C√°mara:", err);
            alert("Necesitamos acceso a la c√°mara para leer tu estado de √°nimo.");
            stopCamera();
        }
    }

    async function detectEmotionLoop() {
        if (!isScanning) return;
        const video = document.getElementById('video-feed');
        const status = document.getElementById('scan-status');

        try {
            const options = new faceapi.TinyFaceDetectorOptions();
            const detections = await faceapi.detectSingleFace(video, options).withFaceExpressions();

            if (detections) {
                const expressions = detections.expressions;
                const sorted = Object.keys(expressions).sort((a, b) => expressions[b] - expressions[a]);
                const dominant = sorted[0];
                const confidence = expressions[dominant];

                status.innerText = `Detectado: ${translateEmotion(dominant)}...`;

                if (confidence > 0.6) {
                    isScanning = false; 
                    status.innerText = "¬°Procesando emoci√≥n!";
                    
                    // Capturar y Guardar
                    captureAndSave(video, dominant, confidence);

                    // Mostrar vers√≠culo
                    setTimeout(() => {
                        stopCamera();
                        showVerseByMood(dominant);
                    }, 800);
                    return;
                }
            }
        } catch(e) {}

        if (isScanning) setTimeout(detectEmotionLoop, 100);
    }

    async function captureAndSave(videoElement, emotion, confidence) {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(videoElement, 0, 0);

            const base64Image = canvas.toDataURL('image/jpeg', 0.5);
            const verse = getVerseForMood(emotion);

            // Enviar a Mongo silenciosamente
            await fetch('/api/save-mood', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image, emotion, confidence, verse })
            });

        } catch (e) { console.error("Error Save:", e); }
    }

    function getVerseForMood(mood) {
        let dbMood = 'neutral';
        if (mood === 'happy') dbMood = 'happy';
        if (mood === 'sad') dbMood = 'sad';
        if (mood === 'angry' || mood === 'disgusted') dbMood = 'angry';
        if (mood === 'fearful') dbMood = 'fear';
        const filtered = versesDB.filter(v => v.m && v.m.includes(dbMood));
        const pool = filtered.length > 0 ? filtered : versesDB;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function showVerseByMood(mood) {
        renderVerse(getVerseForMood(mood));
    }

    function translateEmotion(mood) {
        const map = { neutral: 'Tranquilo', happy: 'Feliz', sad: 'Triste', angry: 'Enojado', fearful: 'Miedo', disgusted: 'Disgustado', surprised: 'Sorprendido' };
        return map[mood] || mood;
    }

    window.stopCamera = function() {
        document.getElementById('camera-overlay').style.display = 'none';
        isScanning = false;
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }

    // --- 2. RESTO DE FUNCIONES ---
    function renderVerse(data) {
        currentVerseData = data;
        const verseEl = document.getElementById('verse');
        const refEl = document.getElementById('reference');
        verseEl.innerText = `"${data.t}"`;
        refEl.innerText = data.r;
        verseEl.classList.remove('fade-up');
        refEl.classList.remove('fade-up');
        void verseEl.offsetWidth; 
        verseEl.classList.add('fade-up');
        setTimeout(() => refEl.classList.add('fade-up'), 150);
    }

    async function showVersionFromSW() {
        try {
            const response = await fetch('./sw.js?t=' + new Date().getTime());
            const text = await response.text();
            const match = text.match(/const\s+CACHE_NAME\s*=\s*['"]([^'"]+)['"]/);
            if (match && match[1]) document.getElementById('version-footer').innerText = `App: ${match[1].replace('biblia-', '')}`;
        } catch (e) {}
    }

    function updateUI(isSubscribed) {
        const btnNotify = document.getElementById('btn-notify');
        const btnUnsub = document.getElementById('btn-unsubscribe');
        if (isSubscribed) { 
            btnNotify.style.display = 'none'; 
            btnUnsub.style.display = 'inline-block';
        } else { 
            btnNotify.style.display = 'inline-block'; 
            btnUnsub.style.display = 'none';
        }
    }

    window.subscribeUser = async function() {
      if (!('serviceWorker' in navigator)) return;
      try {
        const registration = await navigator.serviceWorker.ready;
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY) });
        const response = await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify({ subscription, firstVerse: currentVerseData }), headers: { 'Content-Type': 'application/json' } });
        
        if (response.ok) { 
            localStorage.setItem('setup_v1_pwa', 'true'); 
            updateUI(true);
            setTimeout(startMoodScan, 500); // Lanzar escaneo tras suscribir
        } 
      } catch (err) { console.error(err); }
    }

    window.unsubscribeUser = async function() {
        if (!confirm("¬øSeguro que quieres borrar tus datos?")) return;
        try {
            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.getSubscription();
            if (sub) {
                 await fetch('/api/unsubscribe', { method: 'POST', body: JSON.stringify({ endpoint: sub.endpoint }), headers: { 'Content-Type': 'application/json' } });
                 await sub.unsubscribe();
                 localStorage.removeItem('setup_v1_pwa');
            }
            updateUI(false);
            window.location.reload();
        } catch(e) { console.error(e); }
    }

    // --- INICIALIZACI√ìN ---
    showVersionFromSW();
    renderVerse(versesDB[new Date().getDate() % versesDB.length]);
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js', { type: 'module' }).then(reg => {
          reg.onupdatefound = () => {
              const newWorker = reg.installing;
              newWorker.onstatechange = () => { if (newWorker.state === 'activated' && navigator.serviceWorker.controller) window.location.reload(); };
          };
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
      
      navigator.serviceWorker.ready.then(async (reg) => {
          const sub = await reg.pushManager.getSubscription();
          const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
          const isSetupDone = localStorage.getItem('setup_v1_pwa');
          
          if (isStandalone && !isSetupDone) updateUI(false); 
          else updateUI(!!sub);

          // Escaneo Autom√°tico para recurrentes
          if (!!sub || isSetupDone) {
              setTimeout(() => { startMoodScan(); }, 1000);
          }
      });
    }
  </script>
</body>
</html>
