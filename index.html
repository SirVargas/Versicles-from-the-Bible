<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <title>Vers√≠culo Diario</title>
  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow: hidden; }
    #verse-container { padding: 30px; max-width: 600px; width: 90%; }
    #verse { font-size: 1.6rem; font-style: italic; margin-bottom: 25px; line-height: 1.5; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); }
    #reference { font-weight: bold; margin-top: 15px; color: #bb86fc; font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; }
    
    /* Botones */
    button { margin-top: 30px; padding: 15px 30px; border: none; cursor: pointer; border-radius: 50px; font-weight: 800; font-size: 0.9rem; transition: transform 0.2s; width: 100%; max-width: 300px; }
    button:active { transform: scale(0.95); }
    
    #btn-notify { background: #03dac6; color: #000; box-shadow: 0 4px 15px rgba(3, 218, 198, 0.4); }
    #btn-unsubscribe { background: #cf6679; color: #000; box-shadow: 0 4px 15px rgba(207, 102, 121, 0.4); display: none; }
    
    .status { margin-top: 20px; font-size: 0.8rem; color: #888; height: 20px; }
  </style>
</head>
<body>
  <div id="verse-container">
    <div id="verse">Cargando inspiraci√≥n...</div>
    <div id="reference"></div>
    
    <button id="btn-notify" onclick="window.subscribeUser()">üîî RECIBIR VERS√çCULO DIARIO</button>
    <button id="btn-unsubscribe" onclick="window.unsubscribeUser()">üîï DETENER NOTIFICACIONES</button>
    
    <div id="debug" class="status"></div>
  </div>

  <script type="module">
    import { versesDB } from './js/verses.js';

    // TU CLAVE P√öBLICA (Verifica que sea la misma de Vercel)
    const PUBLIC_VAPID_KEY = 'BPsQjUu_RJyEgJlc86ZPxwu6SNLaRL5DisfvSMd9DrglSHS9wSoXPLCDWb1WKtqc2RIW86el-bwK5q6zN8AXOIk';

    let currentVerseData = null;

    // Utilidad para convertir la clave VAPID
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    function loadLocalVerse() {
       const today = new Date().getDate(); 
       const randomItem = versesDB[today % versesDB.length]; 
       currentVerseData = randomItem;
       document.getElementById('verse').innerText = `"${randomItem.t}"`;
       document.getElementById('reference').innerText = randomItem.r;
    }

    // Actualiza la visibilidad de los botones
    function updateUI(isSubscribed) {
        const btnSub = document.getElementById('btn-notify');
        const btnUnsub = document.getElementById('btn-unsubscribe');
        if (isSubscribed) {
            btnSub.style.display = 'none';
            btnUnsub.style.display = 'inline-block';
        } else {
            btnSub.style.display = 'inline-block';
            btnUnsub.style.display = 'none';
        }
    }

    // --- L√ìGICA DE SUSCRIPCI√ìN (CON LOGS PARA ERUDA) ---
    window.subscribeUser = async function() {
      console.log("üü¶ [UI] Bot√≥n Suscribir presionado.");
      if (!('serviceWorker' in navigator)) return console.error("‚ùå No hay soporte SW");
      
      const debug = document.getElementById('debug');
      debug.innerText = "‚è≥ Procesando...";

      try {
        console.log("üü¶ [UI] Registrando Service Worker...");
        const registration = await navigator.serviceWorker.register('sw.js');
        await navigator.serviceWorker.ready;
        console.log("‚úÖ [UI] Service Worker listo.");

        console.log("üü¶ [UI] Solicitando permiso...");
        const permission = await Notification.requestPermission();
        console.log(`‚ÑπÔ∏è [UI] Permiso obtenido: ${permission}`);
        if (permission !== 'granted') throw new Error("Permiso denegado por el usuario");

        console.log("üü¶ [UI] Creando suscripci√≥n Push...");
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
        });
        
        // Enviamos al backend
        const bodyData = {
            subscription: subscription,
            firstVerse: currentVerseData
        };

        console.log("üü¶ [UI] Enviando datos al servidor...");
        const response = await fetch('/api/subscribe', {
          method: 'POST',
          body: JSON.stringify(bodyData),
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        console.log("üì• [UI] Respuesta del servidor:", data);

        if (response.ok) {
            updateUI(true);
            debug.innerText = "‚úÖ Suscripci√≥n Exitosa.";
            
            // Verificamos si el servidor pudo enviar la push
            if (data.pushStatus && !data.pushStatus.success) {
                console.error("‚ö†Ô∏è [UI] Guardado OK, pero fall√≥ el env√≠o Push:", data.pushStatus.detail);
                alert("Suscrito, pero hubo un error enviando la notificaci√≥n de prueba: " + data.pushStatus.detail);
            } else {
                console.log("‚úÖ [UI] Notificaci√≥n Push enviada por el servidor.");
            }
            
            setTimeout(() => { debug.style.display = 'none'; }, 4000);
        } else {
            throw new Error(data.error || "Error desconocido del servidor");
        }

      } catch (err) {
        console.error("‚ùå [UI] Error:", err);
        debug.innerText = "‚ùå Error: " + err.message;
        
        // Si hay conflicto de llaves, limpiamos
        if (err.name === 'InvalidAccessError') {
             console.warn("‚ôªÔ∏è [UI] Detectada llave inv√°lida. Limpiando...");
             navigator.serviceWorker.getRegistration().then(reg => {
                 if(reg) reg.unregister().then(() => window.location.reload());
             });
        }
      }
    }

    // --- L√ìGICA DE DESUSCRIPCI√ìN ---
    window.unsubscribeUser = async function() {
      console.log("üüß [UI] Bot√≥n Desuscribir presionado.");
      const debug = document.getElementById('debug');
      debug.style.display = 'block';
      debug.innerText = "‚è≥ Cancelando...";

      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
            console.log("üüß [UI] Eliminando de DB...");
            await fetch('/api/unsubscribe', {
                method: 'POST',
                body: JSON.stringify({ endpoint: subscription.endpoint }),
                headers: { 'Content-Type': 'application/json' }
            });

            console.log("üüß [UI] Eliminando del navegador...");
            await subscription.unsubscribe();
        }

        updateUI(false);
        debug.innerText = "üîï Notificaciones desactivadas.";
        console.log("‚úÖ [UI] Desuscripci√≥n completa.");
        setTimeout(() => { debug.style.display = 'none'; }, 4000);

      } catch (err) {
        console.error("‚ùå [UI] Error al cancelar:", err);
        debug.innerText = "‚ùå Error al cancelar.";
      }
    }

    loadLocalVerse();
    
    // Check inicial
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then(async (reg) => {
        try {
          const sub = await reg.pushManager.getSubscription();
          console.log("‚ÑπÔ∏è [UI] Estado inicial: ", sub ? "Suscrito" : "No suscrito");
          updateUI(!!sub);
        } catch(e){}
      });
    }
  </script>
</body>
</html>
