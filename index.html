<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <title>Vers√≠culo Diario</title>
  <style>
    body { background: #121212; color: #e0e0e0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; overflow: hidden; }
    #verse-container { padding: 30px; max-width: 600px; width: 90%; }
    #verse { font-size: 1.6rem; font-style: italic; margin-bottom: 25px; line-height: 1.5; text-shadow: 0px 2px 4px rgba(0,0,0,0.5); }
    #reference { font-weight: bold; margin-top: 15px; color: #bb86fc; font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; }
    #btn-notify { margin-top: 40px; padding: 15px 30px; background: #03dac6; border: none; cursor: pointer; border-radius: 50px; color: #000; font-weight: 800; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(3, 218, 198, 0.4); }
    .status { margin-top: 20px; font-size: 0.8rem; color: #888; }
  </style>
</head>
<body>
  <div id="verse-container">
    <div id="verse">Cargando inspiraci√≥n...</div>
    <div id="reference"></div>
    <button id="btn-notify" onclick="subscribeUser()">üîî RECIBIR VERS√çCULO DIARIO</button>
    <div id="debug" class="status"></div>
  </div>

  <script src="js/verses.js"></script>

  <script>
    // ESTA ES LA CLAVE P√öBLICA QUE GENERAMOS (La misma que pusiste en Vercel)
    const PUBLIC_VAPID_KEY = 'BFOgMvFj_a7M8_y9p5q8R2s4t6u8v0x2z4A6C8E0G2I4K6M8O0Q2S4U6W8Y0a2c4e6g8i0k2m4o6q8s0u2w4';

    // Funci√≥n auxiliar para convertir la llave
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // 1. Cargar un vers√≠culo localmente al abrir la app (para que no se vea vac√≠a)
    function loadLocalVerse() {
       const db = (typeof versesDB !== 'undefined' && versesDB.length > 0) ? versesDB : [{r:"Juan 3:16", t:"Porque de tal manera am√≥ Dios al mundo..."}];
       // Usamos la fecha como semilla para que cambie cada d√≠a localmente
       const today = new Date().getDate(); 
       const randomItem = db[today % db.length]; 
       
       document.getElementById('verse').innerText = `"${randomItem.t}"`;
       document.getElementById('reference').innerText = randomItem.r;
    }

    // 2. Registrar Service Worker y Suscribirse
    async function subscribeUser() {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('Tu celular no soporta notificaciones Push.');
        return;
      }

      try {
        const registration = await navigator.serviceWorker.register('sw.js');
        console.log('SW Registrado');

        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          alert('Necesitamos permiso para enviarte los vers√≠culos.');
          return;
        }

        // Suscribirse al sistema de Google/Vercel
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
        });

        console.log('Suscripci√≥n generada:', subscription);

        // Enviar esta suscripci√≥n a TU BASE DE DATOS en Vercel
        await fetch('/api/subscribe', {
          method: 'POST',
          body: JSON.stringify(subscription),
          headers: {
            'Content-Type': 'application/json'
          }
        });

        document.getElementById('btn-notify').style.display = 'none';
        document.getElementById('debug').innerText = "‚úÖ Conectado al servidor.";
        alert("¬°Listo! Recibir√°s vers√≠culos aunque la app est√© cerrada.");

      } catch (err) {
        console.error('Error:', err);
        document.getElementById('debug').innerText = "‚ùå Error: " + err.message;
      }
    }

    // Iniciar
    loadLocalVerse();
    
    // Verificar si ya est√° suscrito para ocultar bot√≥n
    navigator.serviceWorker.ready.then(async (reg) => {
      const sub = await reg.pushManager.getSubscription();
      if (sub) {
        document.getElementById('btn-notify').style.display = 'none';
        document.getElementById('debug').innerText = "‚úÖ Sistema activo.";
      }
    });

  </script>
</body>
</html>
